
/* 
  PRODUCT MANAGEMENT BACKEND (REFERENCE)
  Tech Stack: Node.js, Express, Mongoose, Cloudinary
*/

// 1. PRODUCT MODEL (product.model.js)
const mongoose = require('mongoose');
const productSchema = new mongoose.Schema({
  name: { type: String, required: true },
  description: { type: String, required: true },
  category: { type: String, required: true },
  subcategory: { type: String },
  price: { type: Number, required: true },
  discountPrice: { type: Number },
  stock: { type: Number, default: 0 },
  brand: { type: String, required: true },
  tags: [String],
  images: [String],
  rating: { type: Number, default: 0 },
  reviewsCount: { type: Number, default: 0 },
  isFeatured: { type: Boolean, default: false },
  deliveryCharge: { type: Number, default: 0 },
  status: { type: String, enum: ['Active', 'Out of Stock'], default: 'Active' },
  createdBy: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }
}, { timestamps: true });

module.exports = mongoose.model('Product', productSchema);

// 2. PRODUCT CONTROLLER (product.controller.js)
exports.createProduct = async (req, res) => {
  try {
    const product = new Product({
      ...req.body,
      createdBy: req.user.id // From auth middleware
    });
    await product.save();
    res.status(201).json(product);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

exports.getProducts = async (req, res) => {
  const { category, brand, search, sort } = req.query;
  let query = {};
  if (category) query.category = category;
  if (brand) query.brand = brand;
  if (search) query.name = { $regex: search, $options: 'i' };
  
  const products = await Product.find(query).sort(sort === 'price_asc' ? 'price' : '-createdAt');
  res.json(products);
};

// 3. API ROUTES (product.routes.js)
const express = require('express');
const router = express.Router();
const { isAdmin, isAuthenticated } = require('../middlewares/auth');

router.post('/admin/products', isAuthenticated, isAdmin, productController.createProduct);
router.get('/products', productController.getProducts);
router.put('/admin/products/:id', isAuthenticated, isAdmin, productController.updateProduct);
router.delete('/admin/products/:id', isAuthenticated, isAdmin, productController.deleteProduct);

module.exports = router;
